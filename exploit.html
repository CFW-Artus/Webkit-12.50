<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>PoC Fuzz WebKit/PS4 - Suite Avanc√©e</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; padding:1em; }
    h1  { color:#0ff; }
    pre, #log, #console, #stats { width:100%; background:#111; color:#0f0; padding:6px; margin:4px 0; max-height:250px; overflow:auto; font-size:14px;}
    button, input[type="button"], select { background:#111; color:#0ff; border:1px solid #0ff; margin:2px; padding:5px 10px; border-radius:6px;}
    #fuzzing, #crash { color:#ff0; font-weight:bold; }
    .err { color:#f00; }
    .ok { color:#0f0; }
    .warn { color:#ff0; }
    .info { color:#0ff; }
    #stats { margin-top:10px; background:#222;}
    #menu { margin-bottom:10px; }
    #templates { margin-top:10px; }
    .template { background:#181818; margin-bottom:3px; padding:4px; border-radius:4px; }
    .template textarea { width:100%; min-height:40px; background:#000; color:#fff;}
  </style>
</head>
<body>

<h1>PoC Fuzz WebKit/PS4 <span id="ver"></span></h1>
<pre id="log"></pre>
<div id="menu">
  <button onclick="pingServeur()">Ping Serveur</button>
  <button onclick="faireDump()">Dump m√©moire</button>
  <button onclick="testerPayload()">Test HEN.bin</button>
  <button onclick="clearConsole()">Clear Console</button>
  <button onclick="clearLog()">Clear Log</button>
  <button onclick="showStats()">Show Stats</button>
  <button onclick="resetStats()">Reset Stats</button>
  <button onclick="runRoutine()">Run 1 Routine</button>
  <button onclick="autoFuzz(10)">Auto-fuzz x10</button>
  <button onclick="autoFuzz(50)">Auto-fuzz x50</button>
</div>

<form id="uploadForm" onsubmit="uploadHen(event)">
  Upload HEN.bin: <input type="file" id="henfile"><button>Envoyer</button>
</form>

<div>
  Routine : 
  <select id="routineSelect"></select>
  <button onclick="editRoutine()">Edit Routine</button>
</div>

<div>
  JS: <input id="consoleInput" placeholder="eval JS‚Ä¶" style="width:65%">
  <button onclick="runConsole()">Ex√©cuter</button>
  <button onclick="consoleInput('runRoutine()')">Routine</button>
  <button onclick="consoleInput('faireDump()')">Dump</button>
</div>
<div id="fuzzing"></div>
<pre id="console"></pre>
<div id="crash"></div>
<pre id="stats"></pre>

<!-- Templates d'exploit/fuzz -->
<div id="templates">
  <h3>Templates/Mutators JS rapides</h3>
  <div id="tplList"></div>
  <button onclick="addTemplate()">+ Nouveau Template</button>
</div>

<script>
// ---- CONFIG -----
const VERSION = "v3.5";
const URL = "http://192.168.1.177:5000";
const HEN_PATH = "/payload/hen.bin";
const MOTIF = 0x41414141, BASE_SPRAY = 40000, MAX_SPRAY = 140000;
const RUNTEMPLATES_KEY = 'fuzz_templates';
// ---- √âTAT -----
let spray=[], routines={}, routineHistory=[], stats={
  runs:0, finds:0, corrupts:[], t0:Date.now(), maxSpray:0, totalRuns:0
};

// ---- UI Utils ----
function log(...m){ document.getElementById("log").textContent += m.join(" ") + "\n"; }
function term(...m){ document.getElementById("console").textContent += m.join(" ") + "\n"; }
function clearConsole(){ document.getElementById("console").textContent=""; }
function clearLog(){ document.getElementById("log").textContent=""; }
function showStats() {
  const s=stats, ms=((Date.now()-s.t0)/1000).toFixed(1);
  document.getElementById("stats").textContent =
    `Runs: ${s.runs}\nTrouv√©s: ${s.finds}\nDernier spray: ${s.maxSpray}\nTotal: ${s.totalRuns}\nCrashs: ${s.corrupts.length}\nTemps: ${ms}s\n` +
    (s.corrupts.length ? "Crashs d√©tect√©s:\n"+s.corrupts.join("\n") : "Aucun crash d√©tect√©.");
}
function resetStats(){ stats={runs:0, finds:0, corrupts:[], t0:Date.now(), maxSpray:0, totalRuns:0}; showStats(); }
function consoleInput(v){ document.getElementById("consoleInput").value = v; }
document.getElementById("ver").textContent = VERSION;

// ---- JS Error Catch ----
window.onerror = (msg, url, line, col, err) => {
  let stack = err?.stack||"";
  log(`[JS ERR] ${msg}@${url}:${line}:${col} UA:${navigator.userAgent}\nStack:${stack}`);
  term("JS ERROR:", msg);
  if(typeof fetch==="function") fetch(URL+"/log",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body: JSON.stringify({log: new Date().toISOString()+" "+msg+" "+stack})
  }).catch(()=>{});
};

// ---- Server/IO ----
function pingServeur(){
  fetch(URL+"/logs").then(_=>term("‚úÖ Serveur OK"))
    .catch(_=>term("‚ùå Serveur injoignable"));
}
function faireDump(){
  const max = Math.min(spray.length, 70);
  const dump = spray.slice(0,max).map((b,i)=>`[${i}]=${Array.from(b.u32).map(hex).join(",")}`).join("\n");
  const hdr = `-- Dump manuel ${new Date().toISOString()} UA:${navigator.userAgent}\n`;
  fetch(URL+"/dump",{method:"POST",headers:{"Content-Type":"application/json"},body: JSON.stringify({dump:hdr+dump+"\n[... tronqu√© ...]"})});
  term("‚úÖ Dump envoy√© ("+max+" buffers)");
  log("Dump manuel envoy√©");
}
function testerPayload(){
  const t0 = performance.now();
  fetch(URL+HEN_PATH).then(r=>r.arrayBuffer()).then(buf=>{
    const dt=(performance.now()-t0).toFixed(1);
    term(`üëç HEN.bin re√ßu ${buf.byteLength} bytes en ${dt} ms`);
    log(`HEN t√©l√©charg√© ${buf.byteLength} bytes en ${dt} ms`);
  }).catch(_=>{
    term("‚ö†Ô∏è HEN.bin non dispo");
    log("Erreur t√©l√©chargement HEN.bin");
  });
}
function uploadHen(e){
  e.preventDefault();
  const f=document.getElementById("henfile").files[0];
  if(!f){ alert("Aucun fichier."); return; }
  const fd=new FormData(); fd.append("file", f);
  fetch(URL+"/upload",{ method:"POST", body: fd })
    .then(r=>r.text()).then(t=>term("Upload:", t))
    .catch(_=> term("‚ùå Erreur upload"));
}

// ---- Routine de base (modifiable) ----
routines["Routine de base"] = function(cfg) {
  spray=[]; let s=cfg.spray;
  for(let i=0;i<s;i++){
    let buf = new ArrayBuffer(20*4); let u = new Uint32Array(buf);
    u.fill(cfg.motif);
    spray.push({u32:u});
  }
  let vict = [1.1,2.2,3.3,4.4];
  for(let i=0;i<cfg.jit;i++) vict[1]=7.7;
  vict.length=1; vict[3]=9.9;
  for(let i=0;i<spray.length;i++){
    let u=spray[i].u32;
    for(let j=0;j<u.length;j++){
      if(u[j]!==cfg.motif){
        stats.finds++; stats.corrupts.push(`[${stats.runs}] idx:${i} off:${j} val:${hex(u[j])}`);
        fetch(URL+"/dump",{method:"POST",headers:{"Content-Type":"application/json"},body: JSON.stringify({dump:`Corruption run#${stats.runs} idx:${i} off:${j} val:${hex(u[j])}`})});
        return true;
      }
    }
  }
  return false;
};
// Exemple routine alternative
routines["Mutation Float Array"] = function(cfg){
  spray=[]; let s=cfg.spray;
  for(let i=0;i<s;i++){
    let buf = new ArrayBuffer(64); let u = new Uint32Array(buf);
    u.fill(cfg.motif^0x1234);
    spray.push({u32:u, f64: new Float64Array(buf)});
  }
  let arr = [1.1,2.2,3.3,4.4];
  for(let i=0;i<cfg.jit*2;i++) arr[2]=cfg.jit/100;
  arr.length=2;
  arr[7]=1337.7331;
  for(let i=0;i<spray.length;i++){
    let u=spray[i].u32;
    if(u[5]!==cfg.motif^0x1234) return true;
  }
  return false;
};

function runRoutine(){
  let sel=document.getElementById("routineSelect");
  let name=sel.value, routine=routines[name]||routines["Routine de base"];
  let cfg = { spray: Math.min(BASE_SPRAY+stats.runs*5000, MAX_SPRAY), motif:MOTIF, jit:3000 };
  stats.runs++; stats.totalRuns++;
  let t1=performance.now();
  let crashed=false;
  try{ crashed=routine(cfg); }catch(e){ crashed=true; log("Routine Exception:",e);}
  let t2=performance.now();
  stats.maxSpray=cfg.spray;
  let res = crashed ? `üí• Crash/corruption d√©tect√© (run#${stats.runs})` : `‚úÖ No crash in run#${stats.runs}`;
  term(res+` (${(t2-t1).toFixed(2)}ms, spray=${cfg.spray})`);
  log(res+` (${(t2-t1).toFixed(2)}ms, spray=${cfg.spray})`);
  showStats();
  return crashed;
}
function autoFuzz(nb=10){
  log(`ü§ñ Auto-fuzz bloquant x${nb}`);
  document.getElementById("fuzzing").textContent = `Fuzz en cours...`;
  for(let i=1;i<=nb;i++){
    term(`üîç Essai ${i}/${nb}`);
    if(runRoutine()){
      term("üí• Crash d√©tect√© √† l'essai", i); break;
    }
  }
  document.getElementById("fuzzing").textContent = "";
}

// ---- Templates Custom ----
function saveTemplates(){
  localStorage.setItem(RUNTEMPLATES_KEY,JSON.stringify(Object.entries(routines).filter(([k])=>!["Routine de base","Mutation Float Array"].includes(k))));
}
function loadTemplates(){
  let raw=localStorage.getItem(RUNTEMPLATES_KEY);
  if(!raw) return;
  try{
    let arr=JSON.parse(raw);
    for(let [k,body] of arr){
      routines[k]=new Function("cfg",body);
    }
  }catch(e){}
}
function renderTemplates(){
  let box=document.getElementById("tplList"); box.innerHTML="";
  for(let k in routines){
    if(k==="Routine de base"||k==="Mutation Float Array") continue;
    let tpl=document.createElement("div"); tpl.className="template";
    tpl.innerHTML=`<b>${k}</b><br>
      <textarea id="tpl_${k}">${routines[k].toString().replace(/^function[^\{]+\{/,"").replace(/\}$/, "")}</textarea>
      <button onclick="saveTemplate('${k}')">üíæ Save</button>
      <button onclick="delTemplate('${k}')">‚ùå Delete</button>`;
    box.appendChild(tpl);
  }
}
function addTemplate(){
  let name=prompt("Nom du template JS (exploit/routine):"); if(!name) return;
  routines[name]=function(cfg){ /* Ici ton code ! */ };
  saveTemplates(); renderTemplates(); refreshRoutineList();
}
function saveTemplate(name){
  let val=document.getElementById("tpl_"+name).value;
  routines[name]=new Function("cfg",val);
  saveTemplates(); renderTemplates(); refreshRoutineList();
}
function delTemplate(name){
  if(confirm("Supprimer la routine "+name+" ?")){ delete routines[name]; saveTemplates(); renderTemplates(); refreshRoutineList();}
}
function editRoutine(){ renderTemplates(); document.getElementById("templates").scrollIntoView(); }
function refreshRoutineList(){
  let sel=document.getElementById("routineSelect"); sel.innerHTML="";
  for(let k in routines){
    let opt=document.createElement("option"); opt.value=k; opt.textContent=k;
    sel.appendChild(opt);
  }
}
window.onload = ()=>{
  loadTemplates(); refreshRoutineList(); renderTemplates(); showStats();
};

// ---- Divers utilitaires ----
function runConsole(){
  const v = document.getElementById("consoleInput").value;
  try{ const r = eval(v); term("‚ñ∂",v,"\n",r); }
  catch(e){ term("‚úñ",e); }
}
function hex(v){ return "0x"+v.toString(16).padStart(8,"0"); }

</script>
</body>
</html>
